#!/bin/bash

<% if @hostname == "devstack-control" %>
########### DevStack-Control ##################################
#sudo ovs-vsctl add-port br-ex eth3
neutron router-interface-delete router1 `neutron net-show private | awk '{if (NR == 13) {print $4}}'`
neutron net-delete private
neutron router-delete router1
sudo ip netns del `sudo ip netns | grep "^qrouter"`
#keystone tenant-delete demo

########### Config rsyslog ####################################
sudo sed -i 's/^#\$ModLoad imtcp/\$ModLoad imtcp/g' /etc/rsyslog.conf
sudo sed -i 's/^#\$InputTCPServerRun.*/\$InputTCPServerRun <%= @rsyslog_port %>/g' /etc/rsyslog.conf 
sudo sed -i '/\$InputTCPServerRun <%= @rsyslog_port %>/a *.* \/var\/log\/remote.log' /etc/rsyslog.conf

########### Install Splunk ####################################
#!/bin/bash
cd /usr/local/src
sudo wget -O splunk-6.2.2-255606-Linux-x86_64.tgz "http://www.splunk.com/page/download_track?file=6.2.2/splunk/linux/splunk-6.2.2-255606-Linux-x86_64.tgz&ac=&wget=true&name=wget&platform=Linux&architecture=x86_64&version=6.2.2&product=splunk&typed=release"
sudo tar zxf splunk-6.2.2-255606-Linux-x86_64.tgz -C /opt/
#sudo rm splunk-6.2.2-255606-Linux-x86_64.tgz
#for file in `sudo ls /opt/stack/log/*[a-z].log`; do sudo echo -e "[monitor://$file]\ndisabled = false\nfollowTail = 0\n"; done > /opt/splunk/etc/apps/launcher/default/inputs.conf
sudo echo -e "[monitor:///var/log/remote.log]\ndisabled = false\nfollowTail = 0\n" > /opt/splunk/etc/apps/launcher/default/inputs.conf
sudo /opt/splunk/bin/splunk start --accept-license --answer-yes --no-prompt
sudo /opt/splunk/bin/splunk enable boot-start
<% end %>

########### Common ############################################
if sudo virsh net-list | grep default; then
    sudo virsh net-destroy default
    sudo virsh net-undefine default
fi

#sudo ovs-vsctl set-manager ptcp:6640
sudo ovs-vsctl set Open_vSwitch `sudo ovs-vsctl get Open_vSwitch . _uuid` other_config={"local_ip"="<%= @hosts[@hostname]['ipaddress_tun'] %>"}
sudo ovs-vsctl list Open_vSwitch .

sudo echo -e "*.* @@<%= @hosts['devstack-control']['name'] %>:<%= @rsyslog_port %>" > /etc/rsyslog.d/90-stack-s.conf
sudo service rsyslog restart

